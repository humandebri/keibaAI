# データスキーマ定義書

## 1. レースデータ（race_data）

### 概要
競馬レースの結果データを格納する主要テーブル

### スキーマ定義

| カラム名 | データ型 | NULL許可 | 説明 | 例 |
|---------|---------|----------|------|-----|
| race_id | VARCHAR(12) | NO | レース識別子（年+場所+開催+日+R） | "202301010101" |
| 出走頭数 | INTEGER | NO | レースの出走頭数 | 18 |
| 馬 | VARCHAR(50) | NO | 馬名 | "ディープインパクト" |
| 騎手 | VARCHAR(30) | NO | 騎手名 | "武豊" |
| 馬番 | INTEGER | NO | 馬番号（1-18） | 1 |
| 調教師 | VARCHAR(30) | YES | 調教師名 | "藤沢和雄" |
| 走破時間 | VARCHAR(10) | YES | 走破タイム（分:秒.秒） | "1:23.4" |
| オッズ | FLOAT | YES | 単勝オッズ | 2.5 |
| 通過順 | VARCHAR(20) | YES | 各通過地点での順位 | "3-3-2-1" |
| 着順 | VARCHAR(5) | NO | 最終着順（数字または文字） | "1", "失格" |
| 体重 | INTEGER | YES | 馬体重（kg） | 480 |
| 体重変化 | INTEGER | YES | 前走からの体重変化 | -2 |
| 性 | CHAR(1) | NO | 性別（牡/牝/セ） | "牡" |
| 齢 | INTEGER | NO | 年齢 | 3 |
| 斤量 | FLOAT | NO | 負担重量（kg） | 57.0 |
| 賞金 | VARCHAR(20) | YES | 獲得賞金 | "3,000,000" |
| 上がり | VARCHAR(10) | YES | 上がり3ハロンタイム | "33.5" |
| 人気 | INTEGER | YES | 人気順位 | 1 |
| レース名 | VARCHAR(100) | YES | レース名称 | "日本ダービー" |
| 日付 | VARCHAR(10) | NO | 開催日（YYYY/MM/DD） | "2023/01/01" |
| 開催 | VARCHAR(10) | NO | 開催回次 | "1回東京1日" |
| クラス | VARCHAR(20) | YES | レースクラス | "G1" |
| 芝・ダート | CHAR(1) | NO | コース種別（芝/ダ） | "芝" |
| 距離 | INTEGER | NO | レース距離（m） | 2400 |
| 回り | CHAR(1) | YES | コース回り（右/左） | "右" |
| 馬場 | VARCHAR(10) | YES | 馬場状態 | "良" |
| 天気 | VARCHAR(10) | YES | 天候 | "晴" |
| 場id | CHAR(2) | NO | 競馬場コード | "05" |
| 場名 | VARCHAR(10) | NO | 競馬場名 | "東京" |

### インデックス
- PRIMARY KEY: (race_id, 馬番)
- INDEX: race_id
- INDEX: 日付
- INDEX: 馬
- INDEX: 騎手

### データ型の詳細説明

#### race_id
- 形式: YYYYPPKKDDRR
  - YYYY: 年（4桁）
  - PP: 場所コード（2桁）
  - KK: 開催回（2桁）
  - DD: 開催日（2桁）
  - RR: レース番号（2桁）

#### 着順
- 通常は数字（1, 2, 3...）
- 特殊ケース: "失格", "取消", "除外", "中止"

#### 性別
- 牡: 牡馬（オス）
- 牝: 牝馬（メス）  
- セ: セン馬（去勢馬）

#### 馬場状態
- 良: 良馬場
- 稍重: 稍重馬場
- 重: 重馬場
- 不良: 不良馬場

## 2. 払戻データ（payback_data）

### 概要
各レースの払戻情報を格納

### スキーマ定義

| カラム名 | データ型 | NULL許可 | 説明 | 例 |
|---------|---------|----------|------|-----|
| race_id | VARCHAR(12) | NO | レース識別子 | "202301010101" |
| 単勝 | JSON | YES | 単勝払戻情報 | ["1", "250"] |
| 複勝 | JSON | YES | 複勝払戻情報 | ["1", "110", "3", "150"] |
| 馬連 | JSON | YES | 馬連払戻情報 | ["1-3", "580"] |
| 馬単 | JSON | YES | 馬単払戻情報 | ["1-3", "1080"] |
| ワイド | JSON | YES | ワイド払戻情報 | ["1-3", "220", "1-5", "340"] |
| 三連複 | JSON | YES | 三連複払戻情報 | ["1-3-5", "2840"] |
| 三連単 | JSON | YES | 三連単払戻情報 | ["1-3-5", "15680"] |

### JSON形式の説明
- 配列形式: [馬番/組み合わせ, 払戻金額, ...]
- 偶数インデックス: 的中馬番または組み合わせ
- 奇数インデックス: 払戻金額（円）

## 3. エンコード済みデータ（encoded_data）

### 概要
機械学習用に前処理・エンコードされたデータ

### 追加カラム

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| 馬_encoded | INTEGER | 馬名のラベルエンコード値 |
| 騎手_encoded | INTEGER | 騎手名のラベルエンコード値 |
| 調教師_encoded | INTEGER | 調教師名のラベルエンコード値 |
| 芝・ダート_encoded | INTEGER | コース種別のエンコード値 |
| 馬場_encoded | INTEGER | 馬場状態のエンコード値 |
| 天気_encoded | INTEGER | 天候のエンコード値 |
| year | INTEGER | 開催年 |
| month | INTEGER | 開催月 |
| day | INTEGER | 開催日 |
| dayofweek | INTEGER | 曜日（0:月曜〜6:日曜） |
| quarter | INTEGER | 四半期（1-4） |
| 騎手_勝率 | FLOAT | 騎手の過去勝率 |
| 馬_平均着順 | FLOAT | 馬の過去平均着順 |
| is_win | INTEGER | 勝利フラグ（1:勝ち, 0:負け） |

## 4. データ品質ルール

### 必須項目
- race_id, 馬, 騎手, 馬番, 着順は必須
- NULL値は明示的に定義された項目のみ許可

### 整合性チェック
1. **馬番の一意性**: 同一レース内で馬番は重複不可
2. **着順の連続性**: 1位から出走頭数まで連続している必要あり
3. **日付の妥当性**: YYYY/MM/DD形式で有効な日付
4. **数値の範囲**:
   - オッズ: 1.0以上1000.0以下
   - 人気: 1以上出走頭数以下
   - 体重: 400kg以上600kg以下
   - 斤量: 40.0kg以上65.0kg以下

### データ更新ルール
- 過去データの更新は原則不可
- 新規データは日次でバッチ追加
- エンコード済みデータは元データ更新時に再生成

## 5. バージョン管理

### データバージョン
- データセットのバージョンはYYYYMMDD形式で管理
- 各バージョンのメタデータをdata_version.jsonに記録

### スキーマバージョン
- 現在のバージョン: 1.0.0
- 変更履歴はCHANGELOG.mdに記録