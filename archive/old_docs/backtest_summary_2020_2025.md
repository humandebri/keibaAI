# 競馬AIバックテスト - 2020-2025年全期間分析

## 概要

2020年から2025年の全データでモデルを訓練し、同期間でバックテストを実行することで、システムの性能を評価します。

## 期待値計算の仕組み

### 基本概念
**期待値 = 的中確率 × オッズ**

期待値が1.0を超える場合、理論上は長期的にプラスになる賭けです。

### 確率計算のプロセス

1. **LightGBMモデルによる着順予測**
   - 各馬の特徴量（過去成績、血統、騎手など）から着順を予測
   - 回帰問題として学習（着順を直接予測）

2. **予測着順から各種確率を計算**
   - **単勝確率**（1着になる確率）
     - 予測着順1.5位以内: 基本確率×2.0（最大40%）
     - 予測着順3位以内: 基本確率×1.5（最大25%）
     - 予測着順5位以内: 基本確率×1.0（最大15%）
   
   - **複勝確率**（3着以内に入る確率）
     - 予測着順3位以内: 基本確率×3.5（最大60%）
     - 予測着順5位以内: 基本確率×2.5（最大40%）
   
   - **2着確率**（馬連用）
     - 予測着順2位以内: 基本確率×1.8（最大30%）
     - 予測着順4位以内: 基本確率×1.3（最大20%）

### 賭け方別の期待値計算

#### 三連単（1着・2着・3着を順番通り当てる）
```
確率 = P(馬1が1着) × P(馬2が2着|馬1が1着) × P(馬3が3着|馬1,2が1,2着)
オッズ = 実際のオッズ（データがある場合）または人気順位から推定
```

#### 馬連（1着・2着を順不同で当てる）
```
確率 = P(馬1が1着かつ馬2が2着) + P(馬2が1着かつ馬1が2着)
```

#### ワイド（3着以内に2頭入れば当たり）
```
確率 = P(馬1と馬2が両方3着以内) × 0.6
```

## 資金管理（Kelly基準25%）

### Kelly基準の計算
```
賭け金額 = 資金 × ケリー割合 × エッジ
エッジ = (期待値 - 1) / (オッズ - 1)
```

### 例
- 資金: 100万円
- ケリー割合: 25% (0.25)
- 期待値: 1.5
- オッズ: 10倍

エッジ = (1.5 - 1) / (10 - 1) = 0.5 / 9 = 0.056
賭け金額 = 1,000,000 × 0.25 × 0.056 = 14,000円

### 安全装置
- 1回の賭けは資金の5%まで
- 賭け種別による調整
  - 三連単: 50%に減額（リスク高）
  - 馬連: 80%に減額
  - ワイド: 100%（調整なし）

## バックテスト設定

### データ
- 期間: 2020年1月～2025年5月
- 使用データ: data_with_payout/（実際のオッズ・払戻データ付き）

### モデル
- アルゴリズム: LightGBM（勾配ブースティング）
- 訓練データ: 2020-2025年全データ
- テストデータ: 2020-2025年全データ（同一期間）

**注意**: 訓練とテストに同じデータを使用するため、実際の運用時より良い結果が出る可能性があります（オーバーフィッティング）。

### 戦略パラメータ
- 最低期待値: 1.05
- Kelly基準: 25%
- 初期資金: 100万円
- 対象: 三連単、馬連、ワイド
- 最大賭け点数: 1レースあたり5点まで

## 実行方法

1. **enhanced_visual_backtest.py**を使用（推奨）
   ```bash
   python enhanced_visual_backtest.py
   ```

2. **main.py**でパラメータ指定
   ```bash
   python main.py backtest --start-year 2020 --end-year 2025 --train-years 2020 2021 2022 2023 2024 2025 --test-years 2020 2021 2022 2023 2024 2025
   ```

## 結果の見方

### 出力ファイル
- **backtest_comprehensive_analysis.png**: 総合分析グラフ
- **backtest_detailed_analysis.png**: 詳細分析グラフ
- **backtest_trades.csv**: 全取引履歴
- **backtest_results.json**: 統計データ

### 重要指標
- **収益率**: (最終資金 - 初期資金) / 初期資金
- **勝率**: 的中数 / 総賭け数
- **ROI**: 利益 / 総投資額
- **最大ドローダウン**: 最大の資金減少率
- **Sharpe比率**: リスク調整後リターン

## 注意事項

1. **データリーク**: 訓練とテストに同じ期間を使用しているため、実運用時より良い結果になる可能性が高い
2. **過去データ**: 過去の成績は将来を保証しない
3. **手数料**: JRA控除率（約20%）は考慮済み
4. **リスク**: ギャンブルには常にリスクが伴う

## まとめ

このシステムは：
- 機械学習で各馬の着順を予測
- 予測から的中確率を計算
- 実際のオッズと組み合わせて期待値を算出
- Kelly基準で適切な賭け金額を決定
- 期待値が1.05以上の賭けのみ実行

理論的には長期的にプラスになるよう設計されていますが、実際の運用では様々な要因により結果が異なる可能性があります。