# 🎯 競馬AI改良システム - ultrathink による実装

## 概要

このシステムは、詳細な分析に基づいて以下の改善を実装しています：

1. **オッズ依存の削減** - 純粋な馬の実力を評価するモデル
2. **高度な特徴量** - 馬場指数、ラップ区間別指数、厩舎成績など
3. **セグメント別モデル** - 芝/ダート、距離別の専門モデル
4. **ROI重視の評価** - 実運用可能性を重視した評価システム
5. **Calibration評価** - 予測確率の信頼性評価

## 🚀 実行方法

### 1. 改良版メインシステムの実行

```bash
# オッズ依存を減らした純粋実力モデル
python keiba_ai_improved_system.py
```

このコマンドで以下が実行されます：
- オッズ系特徴量を除いた純粋実力モデルの訓練
- セグメント別モデルの構築
- ROIシミュレーション
- Kelly基準に基づくベッティング戦略

### 2. ROI詳細分析

```bash
# ROI分析ツールの実行
python roi_analysis_tool.py
```

生成される分析：
- オッズ帯別ROI
- 期待値別パフォーマンス
- ドローダウン分析
- Kelly基準の最適化
- 月別ボラティリティ

### 3. セグメント評価

```bash
# セグメント別モデルの詳細評価
python segment_model_evaluation.py
```

評価内容：
- 芝/ダート × 距離別の性能
- フィールドサイズ別分析
- 馬場状態別分析
- 競馬場別分析

## 📊 期待される結果

### 改良前（オッズ依存モデル）
- 順位相関: 0.724
- 問題: 市場の集合知を写しているだけで手数料負け

### 改良後（純粋実力モデル）
- 順位相関: 0.70-0.72（やや低下）
- ROI: 1.05以上を目指す
- 利点: 市場の歪みを発見可能

## 🔧 カスタマイズ

### 特徴量の調整

`keiba_ai_improved_system.py`の`create_advanced_features`メソッドで調整：

```python
# 例: 血統情報を追加
if '父' in df.columns:
    # 父馬の勝率などを追加
    result['sire_win_rate'] = ...
```

### セグメントの追加

`segment_model_evaluation.py`で新しいセグメントを定義：

```python
self.segment_definitions['custom'] = {
    '若手騎手': {'jockey_experience': (0, 3)},
    'ベテラン騎手': {'jockey_experience': (10, 30)}
}
```

### ROI閾値の調整

`keiba_ai_improved_system.py`の設定を変更：

```python
'betting': {
    'min_roi_threshold': 1.10,  # より厳しく
    'kelly_fraction': 0.05,     # より保守的に
}
```

## 📈 評価指標

### 1. ROI (Return on Investment)
```
ROI = 総払戻金額 / 総賭け金額
```
- 1.0以上: 黒字
- 1.05以上: JRA控除率を上回る
- 1.10以上: 実運用推奨レベル

### 2. Sharpe Ratio
```
Sharpe = (平均リターン - 無リスク金利) / リターンの標準偏差
```
- 1.0以上: 良好
- 1.5以上: 優秀
- 2.0以上: 非常に優秀

### 3. Maximum Drawdown
```
MDD = (最高資産 - 最低資産) / 最高資産
```
- 10%未満: 優秀
- 20%未満: 許容範囲
- 30%以上: 要改善

## ⚠️ 注意事項

1. **過学習の確認**
   - 訓練年と検証年を必ず分ける
   - 年度別Hold-Outで検証

2. **取引コスト**
   - JRA控除率: 約25%
   - この壁を越えるのは容易ではない

3. **実運用前のチェック**
   - 最低1ヶ月のペーパートレード
   - 小額から開始
   - 週次でパフォーマンスレビュー

## 🎯 次のステップ

ROI > 1.0を達成した場合：

1. **詳細検証**
   - 年度別の安定性確認
   - 極端な外れ値の影響確認

2. **リスク管理強化**
   - ポジションサイジングの最適化
   - ストップロス基準の設定

3. **継続的改善**
   - 週次でモデル再訓練
   - 新しい特徴量の探索

ROI < 1.0の場合：

1. **セグメント特化**
   - 最も性能の良いセグメントに集中
   - 専門モデルの深堀り

2. **特徴量の見直し**
   - ドメイン知識の活用
   - 外部データの追加検討

3. **現実的な判断**
   - 市場効率性の受け入れ
   - 他の投資機会の検討