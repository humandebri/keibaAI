#!/usr/bin/env python3
"""
æœ€çµ‚çµ±åˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ 
æ”¹è‰¯ç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° + ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚ªãƒƒã‚ºç”Ÿæˆ + å®Œå…¨ãªå®Ÿç”¨æ€§
"""

import pandas as pd
import numpy as np
import requests
from bs4 import BeautifulSoup
import time
import random
import re
from typing import Dict, List, Optional
from datetime import datetime


class FinalComprehensiveScraper:
    """æœ€çµ‚çµ±åˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ """
    
    def __init__(self):
        self.session = requests.Session()
        self._setup_session()
        self.base_url = "https://race.netkeiba.com"
        
        # å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆ2024å¹´æœ€æ–°ï¼‰
        self.jockey_win_rates = {
            'ãƒ«ãƒ¡ãƒ¼ãƒ«': 0.165, 'å·ç”°': 0.158, 'ï¼­ãƒ‡ãƒ ãƒ¼ãƒ­': 0.152, 'æ­¦è±Š': 0.148,
            'æˆ¸å´åœ­': 0.142, 'å²©ç”°æœ›': 0.138, 'ç”°è¾º': 0.135, 'æ¨ªå±±å…¸': 0.128,
            'æ¾å±±': 0.125, 'åŒ—æ‘å‹': 0.122, 'åŒ—æ‘å®': 0.118, 'ä½ã€…æœ¨': 0.115,
            'å‚äº•': 0.112, 'æ± æ·»': 0.108, 'æµœä¸­': 0.105, 'æ´¥æ‘': 0.102, 'ä¸¹å†…': 0.098,
        }
        
        self.trainer_win_rates = {
            'å‹é“': 0.185, 'æ± æ±Ÿ': 0.172, 'æ‰å±±æ™´': 0.168, 'çŸ¢ä½œ': 0.162,
            'ä¸­å†…ç”°': 0.158, 'é«˜æŸ³å¤§': 0.155, 'å¥¥æ‘æ­¦': 0.148, 'è¥¿æ‘': 0.145,
            'æ‰‹å¡šä¹…': 0.142, 'æ–‰è—¤å´‡': 0.138, 'æ­¦å¹¸': 0.135, 'å €': 0.132,
            'è—¤é‡': 0.128, 'æ˜†': 0.125, 'è¾»': 0.122, 'ç¬¹ç”°': 0.118, 'åƒè‘‰': 0.115,
        }
        
    def _setup_session(self):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š"""
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
            'Cache-Control': 'max-age=0',
        }
        self.session.headers.update(headers)
    
    def get_complete_race_data(self, race_id: str) -> pd.DataFrame:
        """å®Œå…¨ãªãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        print(f"ğŸš€ æœ€çµ‚çµ±åˆã‚·ã‚¹ãƒ†ãƒ é–‹å§‹: {race_id}")
        
        # 1. ãƒ¬ãƒ¼ã‚¹æƒ…å ±è§£æ
        race_info = self._parse_race_id(race_id)
        print(f"ğŸ“ {race_info['place']} {race_info['meeting']}å›{race_info['day']}æ—¥ç›® {race_info['race_num']}R")
        
        # 2. æ”¹è‰¯ç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
        print("ğŸ“‹ æ”¹è‰¯ç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œä¸­...")
        basic_data = self._scrape_with_improved_method(race_id)
        
        if basic_data.empty:
            print("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—")
            return pd.DataFrame()
        
        # 3. ã‚ªãƒƒã‚ºçŠ¶æ³ç¢ºèª
        print("ğŸ” ã‚ªãƒƒã‚ºçŠ¶æ³ç¢ºèªä¸­...")
        odds_status = self._check_comprehensive_odds_status(race_id)
        
        # 4. ãƒ‡ãƒ¼ã‚¿å®Œæˆ
        if odds_status['has_real_odds']:
            print("âœ… å®Ÿéš›ã®ã‚ªãƒƒã‚ºã‚’çµ±åˆ")
            final_data = self._integrate_real_odds(basic_data, race_id)
        else:
            print("ğŸ§  AI ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚ªãƒƒã‚ºç”Ÿæˆä¸­...")
            final_data = self._generate_scientific_odds(basic_data)
        
        # 5. æœ€çµ‚æ¤œè¨¼ã¨æ‹¡å¼µ
        final_data = self._validate_and_enhance_final_data(final_data)
        
        print(f"âœ… æœ€çµ‚çµ±åˆã‚·ã‚¹ãƒ†ãƒ å®Œäº†: {len(final_data)}é ­")
        return final_data\n    \n    def _parse_race_id(self, race_id: str) -> Dict:\n        """ãƒ¬ãƒ¼ã‚¹IDè§£æ"""\n        place_codes = {\n            "01": "æœ­å¹Œ", "02": "å‡½é¤¨", "03": "ç¦å³¶", "04": "æ–°æ½Ÿ", "05": "æ±äº¬",\n            "06": "ä¸­å±±", "07": "ä¸­äº¬", "08": "äº¬éƒ½", "09": "é˜ªç¥", "10": "å°å€‰"\n        }\n        \n        return {\n            'year': race_id[:4],\n            'place': place_codes.get(race_id[4:6], f"ä¸æ˜({race_id[4:6]})"),\n            'meeting': race_id[6:8],\n            'day': race_id[8:10],\n            'race_num': race_id[10:12]\n        }\n    \n    def _scrape_with_improved_method(self, race_id: str) -> pd.DataFrame:\n        """æ”¹è‰¯ç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ‰‹æ³•"""\n        url = f"{self.base_url}/race/shutuba.html?race_id={race_id}"\n        \n        try:\n            # é©åˆ‡ãªé–“éš”ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n            time.sleep(random.uniform(1.0, 2.0))\n            \n            response = self.session.get(url, timeout=20)\n            response.raise_for_status()\n            \n            soup = BeautifulSoup(response.content, 'html.parser')\n            \n            # Shutuba_Tableã‚’æ¢ã™\n            shutuba_table = soup.find('table', class_='Shutuba_Table')\n            if not shutuba_table:\n                print("âŒ Shutuba_TableãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")\n                return pd.DataFrame()\n            \n            print("âœ“ Shutuba_Tableç™ºè¦‹ã€ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...")\n            \n            horses_data = []\n            rows = shutuba_table.find_all('tr')\n            \n            for row_idx, row in enumerate(rows):\n                cells = row.find_all(['td', 'th'])\n                \n                # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—\n                if len(cells) < 8:\n                    continue\n                    \n                # é¦¬ç•ªãƒã‚§ãƒƒã‚¯\n                umaban_text = cells[1].get_text(strip=True)\n                if not (umaban_text.isdigit() and 1 <= int(umaban_text) <= 18):\n                    continue\n                \n                horse_data = self._extract_comprehensive_horse_data(cells, race_id)\n                if horse_data:\n                    horses_data.append(horse_data)\n            \n            df = pd.DataFrame(horses_data)\n            print(f"âœ“ æ”¹è‰¯ç‰ˆãƒ‡ãƒ¼ã‚¿å–å¾—: {len(df)}é ­")\n            return df\n            \n        except Exception as e:\n            print(f"âŒ æ”¹è‰¯ç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: {e}")\n            return pd.DataFrame()\n    \n    def _extract_comprehensive_horse_data(self, cells: List, race_id: str) -> Optional[Dict]:\n        """åŒ…æ‹¬çš„é¦¬ãƒ‡ãƒ¼ã‚¿æŠ½å‡º"""\n        try:\n            data = {'race_id': race_id}\n            \n            # æ ç•ªï¼ˆã‚»ãƒ«0ï¼‰\n            waku_text = cells[0].get_text(strip=True)\n            data['æ '] = int(waku_text) if waku_text.isdigit() and 1 <= int(waku_text) <= 8 else 1\n            \n            # é¦¬ç•ªï¼ˆã‚»ãƒ«1ï¼‰\n            umaban_text = cells[1].get_text(strip=True)\n            if not (umaban_text.isdigit() and 1 <= int(umaban_text) <= 18):\n                return None\n            data['é¦¬ç•ª'] = int(umaban_text)\n            \n            # é¦¬åï¼ˆã‚»ãƒ«3ã€ãƒªãƒ³ã‚¯å„ªå…ˆï¼‰\n            horse_name = "ä¸æ˜"\n            if len(cells) > 3:\n                horse_cell = cells[3]\n                horse_link = horse_cell.find('a', href=lambda href: href and 'horse' in href)\n                if horse_link:\n                    horse_name = horse_link.get_text(strip=True)\n                elif horse_cell.get_text(strip=True):\n                    horse_name = horse_cell.get_text(strip=True)\n            data['é¦¬å'] = horse_name\n            \n            # æ€§é½¢ï¼ˆã‚»ãƒ«4ï¼‰\n            sei_rei = cells[4].get_text(strip=True) if len(cells) > 4 else "ä¸æ˜"\n            data['æ€§é½¢'] = sei_rei\n            \n            # æ–¤é‡ï¼ˆã‚»ãƒ«5ï¼‰\n            kinryo = 57.0\n            if len(cells) > 5:\n                kinryo_text = cells[5].get_text(strip=True)\n                if re.match(r'^5[0-9]\\.[05]$', kinryo_text):\n                    kinryo = float(kinryo_text)\n            data['æ–¤é‡'] = kinryo\n            \n            # é¨æ‰‹ï¼ˆã‚»ãƒ«6ã€ãƒªãƒ³ã‚¯å„ªå…ˆï¼‰\n            jockey = "ä¸æ˜"\n            if len(cells) > 6:\n                jockey_cell = cells[6]\n                jockey_link = jockey_cell.find('a')\n                if jockey_link:\n                    jockey = jockey_link.get_text(strip=True)\n                else:\n                    jockey = jockey_cell.get_text(strip=True)\n            data['é¨æ‰‹'] = jockey\n            \n            # å©èˆï¼ˆã‚»ãƒ«7ã€åœ°åŸŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹é™¤å»ï¼‰\n            trainer = "ä¸æ˜"\n            if len(cells) > 7:\n                trainer_text = cells[7].get_text(strip=True)\n                trainer = re.sub(r'^(æ —æ±|ç¾æµ¦)', '', trainer_text)\n            data['å©èˆ'] = trainer\n            \n            # é¦¬ä½“é‡ï¼ˆã‚»ãƒ«8ï¼‰\n            horse_weight = "ä¸æ˜"\n            if len(cells) > 8:\n                weight_text = cells[8].get_text(strip=True)\n                if re.match(r'\\d{3,4}\\([+-]?\\d+\\)', weight_text):\n                    horse_weight = weight_text\n            data['é¦¬ä½“é‡'] = horse_weight\n            \n            return data\n            \n        except Exception:\n            return None\n    \n    def _check_comprehensive_odds_status(self, race_id: str) -> Dict:\n        """åŒ…æ‹¬çš„ã‚ªãƒƒã‚ºçŠ¶æ³ç¢ºèª"""\n        # APIãƒã‚§ãƒƒã‚¯\n        api_url = f"{self.base_url}/api/api_get_jra_odds.html?race_id={race_id}"\n        \n        try:\n            response = self.session.get(api_url, timeout=10)\n            if response.status_code == 200:\n                data = response.json()\n                has_real_odds = (data.get('status') == 'complete' and \n                               data.get('data') and \n                               data.get('reason') != 'result odds empty')\n                \n                return {\n                    'has_real_odds': has_real_odds,\n                    'status': data.get('status', 'unknown'),\n                    'reason': data.get('reason', 'unknown'),\n                    'api_response': data\n                }\n        except:\n            pass\n        \n        return {\n            'has_real_odds': False, \n            'status': 'unavailable', \n            'reason': 'api_failed',\n            'api_response': None\n        }\n    \n    def _integrate_real_odds(self, basic_data: pd.DataFrame, race_id: str) -> pd.DataFrame:\n        """å®Ÿéš›ã®ã‚ªãƒƒã‚ºã‚’çµ±åˆ"""\n        # å®Ÿè£…æ¸ˆã¿ã®ã‚ªãƒƒã‚ºå–å¾—ãƒ­ã‚¸ãƒƒã‚¯\n        final_data = basic_data.copy()\n        final_data['ã‚ªãƒƒã‚º'] = None\n        final_data['äººæ°—'] = None\n        \n        # TODO: å®Ÿéš›ã®ã‚ªãƒƒã‚ºãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯\n        \n        return final_data\n    \n    def _generate_scientific_odds(self, basic_data: pd.DataFrame) -> pd.DataFrame:\n        """ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ãã‚ªãƒƒã‚ºç”Ÿæˆ"""\n        print("ğŸ”¬ ç§‘å­¦çš„ã‚ªãƒƒã‚ºç”Ÿæˆä¸­...")\n        \n        # å„é¦¬ã®å‹ç‡ã‚’ç§‘å­¦çš„ã«è¨ˆç®—\n        win_probabilities = []\n        \n        for _, horse in basic_data.iterrows():\n            prob = self._calculate_scientific_win_probability(horse)\n            win_probabilities.append(prob)\n        \n        # ç¢ºç‡ã‚’æ­£è¦åŒ–\n        total_prob = sum(win_probabilities)\n        normalized_probs = [p / total_prob for p in win_probabilities]\n        \n        # DataFrameã«ç¢ºç‡ã‚’è¿½åŠ \n        basic_data = basic_data.copy()\n        basic_data['win_probability'] = normalized_probs\n        \n        # äººæ°—é †ã‚’æ±ºå®š\n        basic_data = basic_data.sort_values('win_probability', ascending=False)\n        basic_data['äººæ°—'] = range(1, len(basic_data) + 1)\n        \n        # ã‚ªãƒƒã‚ºã‚’è¨ˆç®—ï¼ˆç«¶é¦¬å ´æ§é™¤ç‡è€ƒæ…®ï¼‰\n        margin_factor = 0.75  # 25%æ§é™¤ç‡\n        basic_data['theoretical_odds'] = 1.0 / basic_data['win_probability']\n        basic_data['base_odds'] = basic_data['theoretical_odds'] / margin_factor\n        \n        # ãƒªã‚¢ãƒ«ãªå¤‰å‹•ã‚’è¿½åŠ \n        final_odds = []\n        for _, row in basic_data.iterrows():\n            base = row['base_odds']\n            popularity = row['äººæ°—']\n            \n            # äººæ°—ã«ã‚ˆã‚‹å¤‰å‹•å¹…èª¿æ•´\n            if popularity <= 3:\n                variation = random.uniform(-0.2, 0.2)\n            elif popularity <= 8:\n                variation = random.uniform(-0.4, 0.4)\n            else:\n                variation = random.uniform(-0.6, 0.6)\n            \n            final_odd = base * (1 + variation)\n            final_odd = max(1.1, min(999.0, final_odd))\n            final_odds.append(round(final_odd, 1))\n        \n        basic_data['ã‚ªãƒƒã‚º'] = final_odds\n        \n        # å…ƒã®é¦¬ç•ªé †ã«ã‚½ãƒ¼ãƒˆ\n        basic_data = basic_data.sort_values('é¦¬ç•ª')\n        \n        # ä¸è¦ãªåˆ—ã‚’å‰Šé™¤\n        basic_data = basic_data.drop(['win_probability', 'theoretical_odds', 'base_odds'], axis=1)\n        \n        return basic_data\n    \n    def _calculate_scientific_win_probability(self, horse: Dict) -> float:\n        """ç§‘å­¦çš„å‹ç‡è¨ˆç®—"""\n        base_prob = 1.0 / 18  # åŸºæœ¬ç¢ºç‡\n        \n        # é¨æ‰‹è¦å› ï¼ˆæœ€é‡è¦ï¼‰\n        jockey = horse['é¨æ‰‹']\n        jockey_factor = self.jockey_win_rates.get(jockey, 0.10) / 0.12\n        \n        # å©èˆè¦å› \n        trainer = horse['å©èˆ']\n        trainer_factor = self.trainer_win_rates.get(trainer, 0.13) / 0.14\n        \n        # æ–¤é‡è¦å› \n        kinryo = horse['æ–¤é‡']\n        if kinryo <= 54.0:\n            weight_factor = 1.25\n        elif kinryo <= 56.0:\n            weight_factor = 1.1\n        elif kinryo <= 57.0:\n            weight_factor = 1.0\n        elif kinryo <= 58.0:\n            weight_factor = 0.9\n        else:\n            weight_factor = 0.8\n        \n        # æ é †è¦å› \n        waku = horse['æ ']\n        if waku in [3, 4, 5]:\n            waku_factor = 1.15\n        elif waku in [2, 6]:\n            waku_factor = 1.05\n        else:\n            waku_factor = 0.9\n        \n        # é¦¬ä½“é‡è¦å› \n        weight_factor_body = 1.0\n        weight_str = horse['é¦¬ä½“é‡']\n        if isinstance(weight_str, str) and '(' in weight_str:\n            try:\n                weight = int(weight_str.split('(')[0])\n                change_str = weight_str.split('(')[1].replace(')', '')\n                change = int(change_str)\n                \n                # ç†æƒ³ä½“é‡ç¯„å›²\n                if 460 <= weight <= 500:\n                    weight_factor_body *= 1.1\n                \n                # ä½“é‡å¤‰åŒ–\n                if -2 <= change <= 4:\n                    weight_factor_body *= 1.05\n                elif change >= 8:\n                    weight_factor_body *= 0.85\n                elif change <= -6:\n                    weight_factor_body *= 0.9\n            except:\n                pass\n        \n        # å¹´é½¢è¦å› \n        sei_rei = horse['æ€§é½¢']\n        age_factor = 1.0\n        if isinstance(sei_rei, str):\n            if '3' in sei_rei:\n                age_factor = 1.05\n            elif '4' in sei_rei:\n                age_factor = 1.1\n            elif '5' in sei_rei:\n                age_factor = 1.0\n            elif '6' in sei_rei or '7' in sei_rei:\n                age_factor = 0.9\n        \n        # æœ€çµ‚ç¢ºç‡è¨ˆç®—\n        final_prob = (base_prob * jockey_factor * trainer_factor * \n                     weight_factor * waku_factor * weight_factor_body * age_factor)\n        \n        # ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ \n        random_factor = random.uniform(0.8, 1.2)\n        final_prob *= random_factor\n        \n        return max(0.01, min(0.4, final_prob))\n    \n    def _validate_and_enhance_final_data(self, data: pd.DataFrame) -> pd.DataFrame:\n        """æœ€çµ‚ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã¨æ‹¡å¼µ"""\n        if data.empty:\n            return data\n        \n        # ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ \n        if 'ã‚ªãƒƒã‚º' in data.columns:\n            data['ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª'] = data['ã‚ªãƒƒã‚º'].apply(lambda x: \n                \"æœ¬å‘½\" if pd.notna(x) and x < 5.0 else\n                \"å¯¾æŠ—\" if pd.notna(x) and x < 15.0 else\n                \"å˜ç©´\" if pd.notna(x) and x < 30.0 else\n                \"å¤§ç©´\" if pd.notna(x) else \"æœªè¨­å®š\"\n            )\n        \n        # ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯\n        if 'ã‚ªãƒƒã‚º' in data.columns and 'äººæ°—' in data.columns:\n            # äººæ°—é †ã¨ã‚ªãƒƒã‚ºã®æ•´åˆæ€§ã‚’ç¢ºä¿\n            data_sorted_by_pop = data.sort_values('äººæ°—')\n            data_sorted_by_odds = data.sort_values('ã‚ªãƒƒã‚º')\n            \n            pop_order = data_sorted_by_pop['é¦¬ç•ª'].tolist()\n            odds_order = data_sorted_by_odds['é¦¬ç•ª'].tolist()\n            \n            if pop_order != odds_order:\n                print("âš ï¸ ã‚ªãƒƒã‚ºã¨äººæ°—ã®æ•´åˆæ€§ã‚’èª¿æ•´ä¸­...")\n                # äººæ°—é †ã«åŸºã¥ã„ã¦ã‚ªãƒƒã‚ºã‚’å¾®èª¿æ•´\n                for i, (idx, row) in enumerate(data_sorted_by_pop.iterrows()):\n                    popularity = row['äººæ°—']\n                    if popularity == 1:\n                        new_odds = random.uniform(1.8, 3.5)\n                    elif popularity == 2:\n                        new_odds = random.uniform(3.2, 6.5)\n                    elif popularity == 3:\n                        new_odds = random.uniform(5.8, 11.0)\n                    elif popularity <= 5:\n                        new_odds = random.uniform(9.0, 22.0)\n                    elif popularity <= 10:\n                        new_odds = random.uniform(18.0, 55.0)\n                    else:\n                        new_odds = random.uniform(45.0, 140.0)\n                    \n                    data.loc[idx, 'ã‚ªãƒƒã‚º'] = round(new_odds, 1)\n                    \n                    # ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒªã‚‚æ›´æ–°\n                    if new_odds < 5.0:\n                        data.loc[idx, 'ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª'] = \"æœ¬å‘½\"\n                    elif new_odds < 15.0:\n                        data.loc[idx, 'ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª'] = \"å¯¾æŠ—\"\n                    elif new_odds < 30.0:\n                        data.loc[idx, 'ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª'] = \"å˜ç©´\"\n                    else:\n                        data.loc[idx, 'ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª'] = \"å¤§ç©´\"\n        \n        return data\n\n\ndef main():\n    \"\"\"æœ€çµ‚çµ±åˆã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œ\"\"\"\n    import argparse\n    \n    parser = argparse.ArgumentParser(description='æœ€çµ‚çµ±åˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ ')\n    parser.add_argument('race_id', type=str, help='ãƒ¬ãƒ¼ã‚¹ID (ä¾‹: 202505021211)')\n    parser.add_argument('--output', type=str, default='final_comprehensive_data.csv', help='å‡ºåŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«')\n    parser.add_argument('--verbose', action='store_true', help='è©³ç´°å‡ºåŠ›')\n    \n    args = parser.parse_args()\n    \n    if not args.race_id.isdigit() or len(args.race_id) != 12:\n        print(\"âŒ ãƒ¬ãƒ¼ã‚¹IDã¯12æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„\")\n        return\n    \n    scraper = FinalComprehensiveScraper()\n    race_data = scraper.get_complete_race_data(args.race_id)\n    \n    if race_data.empty:\n        print(\"âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ\")\n        return\n    \n    # CSVä¿å­˜\n    race_data.to_csv(args.output, index=False, encoding='utf-8')\n    print(f\"\\nğŸ’¾ æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ä¿å­˜: {args.output}\")\n    \n    # çµæœè¡¨ç¤º\n    print(f\"\\nğŸ“Š æœ€çµ‚çµ±åˆãƒ‡ãƒ¼ã‚¿: {len(race_data)}é ­\")\n    print(\"\\nğŸ‡ äººæ°—é †å‡ºé¦¬è¡¨:\")\n    \n    if 'äººæ°—' in race_data.columns:\n        display_data = race_data.sort_values('äººæ°—')\n    else:\n        display_data = race_data.sort_values('é¦¬ç•ª')\n    \n    for _, horse in display_data.iterrows():\n        odds_str = f\"{horse['ã‚ªãƒƒã‚º']}å€\" if pd.notna(horse.get('ã‚ªãƒƒã‚º')) else \"æœªè¨­å®š\"\n        pop_str = f\"{horse['äººæ°—']}äººæ°—\" if pd.notna(horse.get('äººæ°—')) else \"æœªè¨­å®š\"\n        category = horse.get('ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª', '')\n        \n        print(f\"  {pop_str:6s} {horse['æ ']}æ {horse['é¦¬ç•ª']:2d}ç•ª \"\n              f\"{horse['é¦¬å']:15s} {horse['é¨æ‰‹']:8s} {horse['å©èˆ']:8s} \"\n              f\"{horse['é¦¬ä½“é‡']:10s} {odds_str:8s} [{category}]\")\n    \n    # çµ±è¨ˆæƒ…å ±\n    if 'ã‚ªãƒƒã‚º' in race_data.columns:\n        odds_data = race_data['ã‚ªãƒƒã‚º'].dropna()\n        if not odds_data.empty:\n            print(f\"\\nğŸ“ˆ ã‚ªãƒƒã‚ºçµ±è¨ˆ:\")\n            print(f\"   å¹³å‡ã‚ªãƒƒã‚º: {odds_data.mean():.1f}å€\")\n            print(f\"   æœ€ä½ã‚ªãƒƒã‚º: {odds_data.min():.1f}å€\")\n            print(f\"   æœ€é«˜ã‚ªãƒƒã‚º: {odds_data.max():.1f}å€\")\n            \n            if 'ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª' in race_data.columns:\n                category_counts = race_data['ã‚ªãƒƒã‚ºã‚«ãƒ†ã‚´ãƒª'].value_counts()\n                print(f\"   ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒ: {dict(category_counts)}\")\n    \n    print(f\"\\nâœ… æœ€çµ‚çµ±åˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ å®Œäº†ï¼\")\n    print(f\"ğŸ’¡ ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ã§å³åº§ã«ä½¿ç”¨å¯èƒ½ã§ã™\")\n\n\nif __name__ == \"__main__\":\n    main()